////////////////////////////////////////////////////////////////////////////////////////////////////
//
//  Project:  Embedded Learning Library (ELL)
//  File:     DCTTest.cpp (dsp)
//  Authors:  Chuck Jacobs
//
////////////////////////////////////////////////////////////////////////////////////////////////////

#include "DCT.h"
#include "Matrix.h"
#include "MatrixOperations.h"

// testing
#include "testing.h"

// stl
#include <iostream>
#include <type_traits>
#include <vector>

using namespace ell;
using namespace math;
using namespace dsp;

// clang-format off
const std::vector<std::vector<float>> dct_precomputed = {
    { 1.0f,  1.0f,  1.0f,  1.0f,  1.0f,  1.0f,  1.0f,  1.0f,  1.0f,  1.0f,  1.0f,  1.0f,  1.0f,  },  
    { 0.992708874098f,  0.935016242685f,  0.822983865894f, 0.663122658241f, 0.464723172044f, 0.239315664288f, 6.12323399574e-17f, -0.239315664288f, -0.464723172044f, -0.663122658241f, -0.822983865894f, -0.935016242685f, -0.992708874098f, }, 
    { 0.970941817426f, 0.748510748171f, 0.354604887043f, -0.120536680255f, -0.568064746731f, -0.885456025653f, -1.0f, -0.885456025653f, -0.568064746731f, -0.120536680255f, 0.354604887043f, 0.748510748171f, 0.970941817426f, }, 
    { 0.935016242685f, 0.464723172044f, -0.239315664288f, -0.822983865894f, -0.992708874098f, -0.663122658241f, -1.83697019872e-16f, 0.663122658241f, 0.992708874098f, 0.822983865894f, 0.239315664288f, -0.464723172044f, -0.935016242685f, }, 
    { 0.885456025653f, 0.120536680255f, -0.748510748171f, -0.970941817426f, -0.354604887043f, 0.568064746731f, 1.0f, 0.568064746731f, -0.354604887043f, -0.970941817426f, -0.748510748171f, 0.120536680255f, 0.885456025653f, }, 
    { 0.822983865894f, -0.239315664288f, -0.992708874098f, -0.464723172044f, 0.663122658241f, 0.935016242685f, 3.06161699787e-16f, -0.935016242685f, -0.663122658241f, 0.464723172044f, 0.992708874098f, 0.239315664288f, -0.822983865894f, }, 
    { 0.748510748171f, -0.568064746731f, -0.885456025653f, 0.354604887043f, 0.970941817426f, -0.120536680255f, -1.0f, -0.120536680255f, 0.970941817426f, 0.354604887043f, -0.885456025653f, -0.568064746731f, 0.748510748171f, }, 
    { 0.663122658241f, -0.822983865894f, -0.464723172044f, 0.935016242685f, 0.239315664288f, -0.992708874098f, -4.28626379702e-16f, 0.992708874098f, -0.239315664288f, -0.935016242685f, 0.464723172044f, 0.822983865894f, -0.663122658241f, }, 
    { 0.568064746731f, -0.970941817426f, 0.120536680255f, 0.885456025653f, -0.748510748171f, -0.354604887043f, 1.0f, -0.354604887043f, -0.748510748171f, 0.885456025653f, 0.120536680255f, -0.970941817426f, 0.568064746731f, }, 
    { 0.464723172044f, -0.992708874098f, 0.663122658241f, 0.239315664288f, -0.935016242685f, 0.822983865894f, 5.51091059616e-16f, -0.822983865894f, 0.935016242685f, -0.239315664288f, -0.663122658241f, 0.992708874098f, -0.464723172044f, }, 
    { 0.354604887043f, -0.885456025653f, 0.970941817426f, -0.568064746731f, -0.120536680255f, 0.748510748171f, -1.0f, 0.748510748171f, -0.120536680255f, -0.568064746731f, 0.970941817426f, -0.885456025653f, 0.354604887043f, }, 
    { 0.239315664288f, -0.663122658241f, 0.935016242685f, -0.992708874098f, 0.822983865894f, -0.464723172044f, -2.44991257893e-15f, 0.464723172044f, -0.822983865894f, 0.992708874098f, -0.935016242685f, 0.663122658241f, -0.239315664288f, }, 
    { 0.120536680255f, -0.354604887043f, 0.568064746731f, -0.748510748171f, 0.885456025653f, -0.970941817426f, 1.0f, -0.970941817426f, 0.885456025653f, -0.748510748171f, 0.568064746731f, -0.354604887043f, 0.120536680255f, }, 
};
// clang-format on

template <typename ValueType>
RowMatrix<ValueType> GetRowMatrix(const std::vector<std::vector<ValueType>>& values)
{
    auto numRows = values.size();
    auto numColumns = values[0].size();
    RowMatrix<ValueType> result(numRows, numColumns);
    for (size_t rowIndex = 0; rowIndex < numRows; ++rowIndex)
    {
        const auto& row = values[rowIndex];
        if (row.size() != numColumns)
        {
            throw;
        }
        for (size_t columnIndex = 0; columnIndex < numColumns; ++columnIndex)
        {
            result(rowIndex, columnIndex) = row[columnIndex];
        }
    }
    return result;
}

void TestDCT()
{
    const float epsilon = 1e-5f;
    auto refMatrix = GetRowMatrix(dct_precomputed);
    auto dctMatrix = GetDCTMatrix<float>(dct_precomputed.size());
    testing::ProcessTest("Testing DCT generation", dctMatrix.IsEqual(refMatrix, epsilon));
}